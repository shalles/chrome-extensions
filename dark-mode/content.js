var T=Object.defineProperty,b=(n,e,t)=>e in n?T(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,l=(n,e,t)=>(b(n,typeof e!="symbol"?e+"":e,t),t);function v(n,e){const t=[`.${n} img`,`.${n} :not(img)[style*="background-image"]`],s=/background(-image)?:[ a-zA-Z0-9_-]*url\(/;return Array.prototype.forEach.call(e.styleSheets,i=>{try{return Array.prototype.forEach.call(i.rules,a=>{s.test(a.cssText)&&a.selectorText!=="undefined"&&t.push(`.${n} ${a.selectorText}`)})}catch{return!1}}),t.join(", ")}const h="dark-mode-2c9ef1a",o=`theme__root--${h}`;function d({invert:n,contrast:e,saturate:t,hueRotate:s}={}){return`
  .${o} {
    filter: invert(${n||1}) contrast(${e||.95}) saturate(${t||.8}) hue-rotate(${s||180}deg);
  }
  `}function m(n=window.document,{invert:e,contrast:t,saturate:s,hueRotate:i}={}){return`
  ${v(o,n)} {
    filter: invert(${e||1}) contrast(${t||.95}) saturate(${s||1.5}) hue-rotate(${i||180}deg);
  }
  `}function w(n){return`
  @media (prefers-color-scheme: dark) {
    ${n}
  }
  `}class M{constructor({enableType:e,timeRange:t,rootElement:s}){l(this,"timeRange",{begin:1800,end:2400+700}),l(this,"timeRangeTimerId",0),l(this,"enableType","system"),l(this,"rootElement"),l(this,"styleElement"),this.rootElement=s||document.documentElement,this.enableType=e||this.enableType,this.setEnableType(this.enableType,t)}resetFrameEnv(e,t){e||(e=this.rootElement),t||(t=this.styleElement),this.timeRangeTimerId&&clearTimeout(this.timeRangeTimerId),e.classList.remove(o),t.innerHTML=""}async onSettingUpdate(e=window.document,t,s=3){t||(t=this.rootElement);let i="";s===3?i=d()+m(e):s===2?i=m(e):s===1&&(i=d());let a=t==null?void 0:t.querySelector("head");if(a||(a=t),(!this.styleElement||t!==this.rootElement)&&(this.styleElement=e.createElement("style"),a.appendChild(this.styleElement)),this.resetFrameEnv(t,this.styleElement),this.enableType==="always")this.styleElement.innerHTML=i,t==null||t.classList.add(o);else if(this.enableType==="system")this.styleElement.innerHTML=w(i),t==null||t.classList.add(o);else if(this.enableType==="time-range"){const r=()=>{this.isTimeInRange(new Date)?(this.styleElement.innerHTML=i,t==null||t.classList.add(o)):t==null||t.classList.remove(o),this.timeRangeTimerId=setTimeout(r,1e4)};r()}}isDarkMode(){var e;return(e=this.rootElement)==null?void 0:e.classList.contains(o)}isTimeInRange(e){if(this.enableType!=="time-range")return!1;const t=e.getHours(),s=e.getMinutes(),i=t*100+s|0,{begin:a,end:r}=this.timeRange;return a<i&&i<r||a<i+2400&&i+2400<r}setEnableType(e,t){!e||(this.enableType=e,e==="time-range"?this.setEnableTimeRange(t):this.onSettingUpdate())}setEnableTimeRange(e){if(!e)return;const{begin:t,end:s}=e;this.timeRange.begin=t,this.timeRange.end=s<t?s+2400:s,this.onSettingUpdate()}}var p=(n=>(n[n.LOADING=0]="LOADING",n[n.LOADED=1]="LOADED",n[n.ERROR=2]="ERROR",n))(p||{});class I{constructor(e=1e3){l(this,"pool",[]),l(this,"timerId",0),this.interval=e}startMachine2(){this.stopMachine();const e=(async()=>{this.pool=this.pool.filter(t=>t.state===0),this.pool.forEach(t=>{const{state:s,check:i,handler:a}=t;try{i(s)&&(t.state=a(s)?1:0)}catch{t.state=2}}),clearTimeout(this.timerId),this.timerId=setTimeout(e,this.interval)}).bind(this);e()}startMachine(){this.stopMachine(),this.timerId=setInterval(async()=>{this.pool=this.pool.filter(e=>e.state===0),this.pool.forEach(e=>{const{state:t,check:s,handler:i}=e;try{s(t)&&(e.state=i(t)?1:0)}catch{e.state=2}})},this.interval)}setInterval(e){this.interval=e,this.startMachine()}getInterval(){return this.interval}stopMachine(){this.timerId&&clearInterval(this.timerId)}register(e,t){return this.pool.find(s=>s.key===e.key)||(this.pool.push(Object.assign({state:0},e)),this.startMachine(),t&&(t<this.interval&&(t=this.interval+200),setTimeout(()=>{this.unregister(e.key),this.stopMachine()},t))),!0}unregister(e){const t=this.pool.findIndex(s=>s.key!==e);this.pool.splice(t,1)}}class R extends M{constructor(e){super(e),l(this,"stateMachine"),console.log("MultiFrameDarkMode:",this.stateMachine),this.onMessageFromTopWindow()}async onMessageFromTopWindow(){const e={this:this,window},t=(i,a)=>{let r=i;for(let c=0;r&&c<a.length;c++)r=r[a[c]];return r},s=i=>{const a=i.split("."),r=a[0];return e[r]?t(e[r],a.slice(1)):()=>{}};window.addEventListener("message",i=>{try{const{from:a,type:r,data:c}=JSON.parse(i.data);if(a===h&&r==="exec-fn"){const f=c.args.map(E=>s(E));s(c.fn).call(this,...f)}}catch{}},!1)}async onSettingUpdate(){super.onSettingUpdate();const e=async()=>{Array.prototype.forEach.call(window.frames,i=>{try{super.onSettingUpdate(i.document,i.document.documentElement,2)}catch(a){/from accessing a cross-origin frame/.test(a)&&i.postMessage(JSON.stringify({from:h,type:"exec-fn",data:{fn:"this.onSettingUpdate",args:["window.document",2]}}),"*")}})};let t=window.frames.length;t&&e();const s="onIframeLoaded";this.stateMachine||(this.stateMachine=new I(1e3)),this.stateMachine.register({key:s,state:p.LOADING,check(){return window.frames.length>t?(t=window.frames.length,!0):!1},handler:()=>{var i;return(i=this.stateMachine)==null||i.setInterval(5e3),e(),!1}},2e4)}}function u(n){return window.localStorage.getItem(`dark-mode-2c9ef1a:${n}`)}function g(n,e){window.localStorage.setItem(`dark-mode-2c9ef1a:${n}`,e)}function y(n=u("enableType")||"never",e={begin:0,end:0}){try{const{begin:t,end:s}=JSON.parse(u("timeRange")||"{}");!e.begin&&t&&(e.begin=t),!e.end&&s&&(e.end=s>2400?s-2400:s),g("enableType",n),g("timeRange",JSON.stringify(e))}catch(t){console.log(t)}new R({rootElement:document.documentElement,enableType:n,timeRange:e})}y();chrome.runtime.onMessage.addListener(n=>{const e=JSON.parse(n);y(e.enableType,e.timeRange),window.location.reload()});
